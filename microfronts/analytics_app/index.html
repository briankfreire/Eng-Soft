<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Analytics Service – MVP Front</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background: #f5f6fa;
        color: #2c3e50;
      }
      h1, h2 {
        color: #e67e22;
      }
      section {
        background: #ffffff;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }
      label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: bold;
      }
      input, textarea, button {
        padding: 0.5rem;
        margin-bottom: 0.75rem;
        width: 100%;
        box-sizing: border-box;
      }
      textarea {
        min-height: 120px;
      }
      button {
        background: #e67e22;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      pre {
        background: #ecf0f1;
        padding: 1rem;
        border-radius: 6px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>Analytics Service – MVP Front</h1>
    <p>
      Registre eventos de uso e acompanhe métricas para demonstrar a capacidade de medir sucesso logo no MVP.
      Backend esperado em <code>http://localhost:5004</code>.
    </p>

    <section>
      <h2>Registrar Evento</h2>
      <label for="event-type">Tipo do evento</label>
      <input id="event-type" type="text" placeholder="profile.completed" />

      <label for="event-user-id">User ID (opcional)</label>
      <input id="event-user-id" type="number" min="1" placeholder="1" />

      <label for="event-payload">Payload JSON (opcional)</label>
      <textarea id="event-payload" placeholder='{"origin": "microfront"}'></textarea>

      <button onclick="recordEvent()">Registrar evento</button>
    </section>

    <section>
      <h2>Eventos Recentes</h2>
      <label for="events-limit">Limite</label>
      <input id="events-limit" type="number" min="1" max="100" value="10" />
      <button onclick="loadRecentEvents()">Carregar eventos</button>
      <pre id="recent-events-output">Nenhum evento consultado ainda.</pre>
    </section>

    <section>
      <h2>Métricas</h2>
      <button onclick="loadMetrics()">Atualizar métricas</button>
      <pre id="metrics-output">Ainda não carregado.</pre>
    </section>

    <script>
      const API_BASE = "http://localhost:5004";

      function parsePayload(raw) {
        if (!raw.trim()) {
          return {};
        }
        try {
          return JSON.parse(raw);
        } catch (err) {
          alert("Payload inválido. Usando objeto vazio.");
          return {};
        }
      }

      async function recordEvent() {
        const eventType = document.getElementById("event-type").value.trim();
        const userIdRaw = document.getElementById("event-user-id").value;
        const payloadRaw = document.getElementById("event-payload").value;
        if (!eventType) {
          alert("Informe um tipo de evento.");
          return;
        }

        const payload = {
          event_type: eventType,
          payload: parsePayload(payloadRaw),
        };
        if (userIdRaw) {
          payload.user_id = parseInt(userIdRaw, 10);
        }

        try {
          const response = await fetch(`${API_BASE}/events`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await response.json();
          if (!response.ok) {
            throw data;
          }
          alert("Evento registrado com sucesso.");
          loadRecentEvents();
          loadMetrics();
        } catch (error) {
          alert(`Erro ao registrar evento: ${JSON.stringify(error)}`);
        }
      }

      async function loadRecentEvents() {
        const limit = document.getElementById("events-limit").value || 10;
        try {
          const response = await fetch(`${API_BASE}/events/recent?limit=${limit}`);
          const data = await response.json();
          if (!response.ok) {
            throw data;
          }
          document.getElementById("recent-events-output").textContent = JSON.stringify(data.events, null, 2);
        } catch (error) {
          document.getElementById("recent-events-output").textContent = JSON.stringify(error, null, 2);
        }
      }

      async function loadMetrics() {
        try {
          const response = await fetch(`${API_BASE}/metrics`);
          const data = await response.json();
          if (!response.ok) {
            throw data;
          }
          document.getElementById("metrics-output").textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          document.getElementById("metrics-output").textContent = JSON.stringify(error, null, 2);
        }
      }
    </script>
  </body>
</html>
